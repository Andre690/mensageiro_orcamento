<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disparador de Mensagens - Orçamento</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .header {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.1) 2px,
                rgba(255,255,255,0.1) 4px
            );
            animation: move 10s linear infinite;
        }
        
        @keyframes move {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border-left: 5px solid #007bff;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .stat-card.danger { border-left-color: #dc3545; }
        .stat-card.warning { border-left-color: #ffc107; }
        .stat-card.success { border-left-color: #28a745; }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1rem;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Configuração da API */
        .config-section {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .config-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .config-field label {
            font-weight: 600;
            color: #333;
        }

        .config-field input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .config-field input:focus {
            outline: none;
            border-color: #25D366;
            box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);
        }

        .test-api-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-api-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
        }
        
        .file-upload {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .upload-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border: 2px dashed #ddd;
            transition: all 0.3s ease;
        }
        
        .upload-card:hover {
            border-color: #25D366;
            transform: translateY(-2px);
        }
        
        .upload-card.loaded {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: block;
            cursor: pointer;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .file-label:hover {
            background: #e9ecef;
        }
        
        .file-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .setor-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border-left: 4px solid #007bff;
        }
        
        .setor-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .setor-item.danger { border-left-color: #dc3545; }
        .setor-item.warning { border-left-color: #ffc107; }
        .setor-item.success { border-left-color: #28a745; }
        
        .setor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .setor-name {
            font-weight: bold;
            font-size: 1.2rem;
            color: #333;
        }
        
        .setor-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .status-danger { background: #dc3545; color: white; }
        .status-warning { background: #ffc107; color: #333; }
        .status-success { background: #28a745; color: white; }
        
        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .progress-danger { background: linear-gradient(90deg, #dc3545, #c82333); }
        .progress-warning { background: linear-gradient(90deg, #ffc107, #e0a800); }
        .progress-success { background: linear-gradient(90deg, #28a745, #20c997); }
        
        .btn {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px auto;
            max-width: 300px;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.4);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            background: white;
        }
        
        .log-item {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .log-success { border-left-color: #28a745; background: #d4edda; }
        .log-error { border-left-color: #dc3545; background: #f8d7da; }
        .log-info { border-left-color: #17a2b8; background: #d1ecf1; }
        .log-warning { border-left-color: #ffc107; background: #fff3cd; }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #25D366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 15px;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }

        .alert-danger {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        .api-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .api-status.online {
            background: #d4edda;
            color: #155724;
        }

        .api-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .api-status.testing {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Disparador de Mensagens</h1>
            <p>Sistema de Controle Orçamentário - WhatsApp</p>
        </div>
        
        <div class="main-content">
            <!-- Configuração da API -->
            <div class="config-section">
                <h2>⚙️ Configuração da API WhatsApp 
                    <span class="api-status offline" id="apiStatus">OFFLINE</span>
                </h2>
                <div class="config-grid">
                    <div class="config-field">
                        <label for="apiUrl">URL da API:</label>
                        <input type="text" id="apiUrl" value="http://192.168.99.41:8080" placeholder="Ex: http://192.168.99.41:8080">
                    </div>
                    <div class="config-field">
                        <label for="apiInstance">Instância:</label>
                        <input type="text" id="apiInstance" value="MensageiroOrcamento" placeholder="Nome da instância">
                    </div>
                    <div class="config-field">
                        <label for="apiKey">Chave da API:</label>
                        <input type="text" id="apiKey" value="T0pF4m4D3vs" placeholder="Sua chave da API">
                    </div>
                    <div style="display: flex; align-items: end;">
                        <button class="test-api-btn" onclick="window.testarAPI()">🔍 Testar Conexão</button>
                    </div>
                </div>
            </div>

            <!-- Upload de Arquivos -->
            <div class="section">
                <h2>📋 Carregar Planilhas
                    <button class="refresh-btn" onclick="window.recarregarDados()">🔄 Atualizar</button>
                </h2>
                <div class="alert alert-info">
                    <strong>💡 Dica:</strong> Carregue as 3 planilhas (Excel .xlsx/.xls ou CSV) para visualizar os dados mais recentes. Os arquivos serão processados automaticamente.
                </div>
                <div class="file-upload">
                    <div class="upload-card" id="uploadCard1">
                        <div class="file-icon">📊</div>
                        <strong>Orçamento Geral</strong>
                        <p style="margin: 10px 0; color: #666;">arquivodedados.xlsx</p>
                        <div class="file-label" onclick="document.getElementById('fileSetor').click()">
                            📤 Carregar Arquivo
                        </div>
                        <input type="file" id="fileSetor" class="file-input" accept=".xlsx,.xls,.csv" onchange="window.carregarArquivoSetor(event)">
                        <div id="statusSetor">Aguardando arquivo...</div>
                    </div>
                    
                    <div class="upload-card" id="uploadCard2">
                        <div class="file-icon">📋</div>
                        <strong>Orçamento Categoria</strong>
                        <p style="margin: 10px 0; color: #666;">OrcamentoCategoria.xlsx</p>
                        <div class="file-label" onclick="document.getElementById('fileCategoria').click()">
                            📤 Carregar Arquivo
                        </div>
                        <input type="file" id="fileCategoria" class="file-input" accept=".xlsx,.xls,.csv" onchange="window.carregarArquivoCategoria(event)">
                        <div id="statusCategoria">Aguardando arquivo...</div>
                    </div>
                    
                    <div class="upload-card" id="uploadCard3">
                        <div class="file-icon">📞</div>
                        <strong>Contatos Setores</strong>
                        <p style="margin: 10px 0; color: #666;">contato_setores.xlsx</p>
                        <div class="file-label" onclick="document.getElementById('fileContatos').click()">
                            📤 Carregar Arquivo
                        </div>
                        <input type="file" id="fileContatos" class="file-input" accept=".xlsx,.xls,.csv" onchange="window.carregarArquivoContatos(event)">
                        <div id="statusContatos">Aguardando arquivo...</div>
                    </div>
                </div>
            </div>
            
            <!-- Estatísticas Gerais -->
            <div class="stats-grid">
                <div class="stat-card danger">
                    <div class="stat-number" id="setoresUltrapassados">-</div>
                    <div class="stat-label">🚨 Setores Ultrapassados</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-number" id="setoresProximos">-</div>
                    <div class="stat-label">⚠️ Setores Próximos (90%+)</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-number" id="setoresControlados">-</div>
                    <div class="stat-label">✅ Setores Controlados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSetores">-</div>
                    <div class="stat-label">📈 Total de Setores</div>
                </div>
            </div>
            
            <!-- Relatório de Setores -->
            <div class="section">
                <h2>📈 Situação dos Setores</h2>
                <div id="setoresList">
                    <div class="alert alert-warning">
                        <strong>⚠️ Atenção:</strong> Carregue os arquivos Excel acima para visualizar os dados dos setores.
                    </div>
                </div>
            </div>
            
            <!-- Botão Disparador -->
            <button class="btn" id="disparadorBtn" onclick="window.dispararMensagens()" disabled>
                <span>📤</span>
                Disparar Mensagens para Setores
            </button>
            
            <!-- Log de Envios -->
            <div class="section">
                <h2>📝 Log de Envios</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-item log-info">
                        Sistema inicializado. Configure a API e carregue os arquivos Excel para começar...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Definir todas as variáveis e funções no escopo global (window)
        window.dadosSetor = null;
        window.dadosCategoria = null;
        window.dadosContatos = null;
        window.dadosProcessados = [];

        // Função para adicionar logs
        window.adicionarLog = function(tipo, mensagem, timestamp = new Date()) {
            const logContainer = document.getElementById('logContainer');
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${tipo}`;
            
            const timeStr = timestamp.toLocaleTimeString('pt-BR');
            logItem.innerHTML = `<strong>[${timeStr}]</strong> ${mensagem}`;
            
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Limita o número de logs exibidos (máximo 100)
            const logs = logContainer.querySelectorAll('.log-item');
            if (logs.length > 100) {
                logs[0].remove();
            }
        };

        // Função para testar a API
        window.testarAPI = function() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiInstance = document.getElementById('apiInstance').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusElement = document.getElementById('apiStatus');

            if (!apiUrl || !apiInstance || !apiKey) {
                window.adicionarLog('error', 'Por favor, preencha todos os campos da API');
                return;
            }

            statusElement.textContent = 'TESTANDO...';
            statusElement.className = 'api-status testing';
            
            window.adicionarLog('info', 'Testando conexão com a API...');

            const url = `${apiUrl}/instance/fetchInstances`;
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'apikey': apiKey,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    statusElement.textContent = 'ONLINE';
                    statusElement.className = 'api-status online';
                    window.adicionarLog('success', '✅ API conectada com sucesso!');
                } else {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
            })
            .catch(error => {
                statusElement.textContent = 'OFFLINE';
                statusElement.className = 'api-status offline';
                window.adicionarLog('error', `❌ Erro ao conectar com a API: ${error.message}`);
                window.adicionarLog('warning', '⚠️ Verifique se a API está rodando e se a URL/chave estão corretas');
            });
        };

        // Função para formatar número de telefone
        window.formatarTelefone = function(numero) {
            if (!numero) return '';
            
            // Remove todos os caracteres não numéricos
            let tel = numero.toString().replace(/\D/g, '');
            
            // Se começar com 0, remove
            if (tel.startsWith('0')) {
                tel = tel.substring(1);
            }
            
            // Se não começar com 55 (código do Brasil), adiciona
            if (!tel.startsWith('55')) {
                tel = '55' + tel;
            }
            
            // Garante que tem pelo menos 13 dígitos (55 + DDD + 9 dígitos)
            if (tel.length < 13) {
                window.adicionarLog('warning', `⚠️ Número ${numero} pode estar incompleto: ${tel}`);
            }
            
            return tel;
        };

        // Função auxiliar para processar CSV
        window.csvParaJSON = function(csvText) {
            const linhas = csvText.split('\n');
            if (linhas.length === 0) return [];
            
            const headers = linhas[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const dados = [];

            for (let i = 1; i < linhas.length; i++) {
                if (linhas[i].trim() === '') continue;
                
                const valores = linhas[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const objeto = {};
                
                headers.forEach((header, index) => {
                    let valor = valores[index] || '';
                    
                    // Tenta converter números
                    if (!isNaN(valor) && valor !== '' && valor !== '-') {
                        valor = parseFloat(valor.replace(',', '.'));
                    }
                    
                    objeto[header] = valor;
                });
                
                dados.push(objeto);
            }

            return dados;
        };

        // Função para processar qualquer tipo de arquivo
        window.processarArquivo = function(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let dados;
                    
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        // Processamento CSV
                        const csvText = e.target.result;
                        dados = window.csvParaJSON(csvText);
                    } else {
                        // Processamento Excel
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        dados = XLSX.utils.sheet_to_json(worksheet);
                    }
                    
                    // Validação básica
                    if (!dados || dados.length === 0) {
                        throw new Error('Arquivo vazio ou sem dados válidos');
                    }
                    
                    callback(null, dados);
                } catch (error) {
                    callback(error, null);
                }
            };
            
            reader.onerror = function(error) {
                callback(new Error('Erro ao ler o arquivo'), null);
            };
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        };

        // Funções de carregamento de arquivos
        window.carregarArquivoSetor = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            window.processarArquivo(file, (error, dados) => {
                if (error) {
                    window.adicionarLog('error', `Erro ao carregar arquivo de orçamento geral: ${error.message}`);
                    document.getElementById('statusSetor').innerHTML = '❌ Erro';
                    document.getElementById('statusSetor').style.color = '#dc3545';
                    return;
                }

                // Validação específica para arquivo de setores
                const primeiroItem = dados[0];
                if (!primeiroItem.hasOwnProperty('Setor') || !primeiroItem.hasOwnProperty('ORÇADO')) {
                    window.adicionarLog('error', 'Arquivo de orçamento geral deve conter as colunas "Setor" e "ORÇADO"');
                    document.getElementById('statusSetor').innerHTML = '❌ Formato Inválido';
                    document.getElementById('statusSetor').style.color = '#dc3545';
                    return;
                }

                window.dadosSetor = dados;
                document.getElementById('statusSetor').innerHTML = '✅ Carregado';
                document.getElementById('statusSetor').style.color = '#28a745';
                document.getElementById('uploadCard1').classList.add('loaded');
                
                window.adicionarLog('success', `Arquivo de orçamento geral carregado: ${window.dadosSetor.length} registros`);
                window.processarDados();
            });
        };

        window.carregarArquivoCategoria = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            window.processarArquivo(file, (error, dados) => {
                if (error) {
                    window.adicionarLog('error', `Erro ao carregar arquivo de categoria: ${error.message}`);
                    document.getElementById('statusCategoria').innerHTML = '❌ Erro';
                    document.getElementById('statusCategoria').style.color = '#dc3545';
                    return;
                }

                // Validação específica para arquivo de categorias
                const primeiroItem = dados[0];
                if (!primeiroItem.hasOwnProperty('Setor') || !primeiroItem.hasOwnProperty('Classificação')) {
                    window.adicionarLog('error', 'Arquivo de categoria deve conter as colunas "Setor" e "Classificação"');
                    document.getElementById('statusCategoria').innerHTML = '❌ Formato Inválido';
                    document.getElementById('statusCategoria').style.color = '#dc3545';
                    return;
                }

                window.dadosCategoria = dados;
                document.getElementById('statusCategoria').innerHTML = '✅ Carregado';
                document.getElementById('statusCategoria').style.color = '#28a745';
                document.getElementById('uploadCard2').classList.add('loaded');
                
                window.adicionarLog('success', `Arquivo de orçamento por categoria carregado: ${window.dadosCategoria.length} registros`);
                window.processarDados();
            });
        };

        window.carregarArquivoContatos = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            window.processarArquivo(file, (error, dados) => {
                if (error) {
                    window.adicionarLog('error', `Erro ao carregar arquivo de contatos: ${error.message}`);
                    document.getElementById('statusContatos').innerHTML = '❌ Erro';
                    document.getElementById('statusContatos').style.color = '#dc3545';
                    return;
                }

                // Validação específica para arquivo de contatos
                const primeiroItem = dados[0];
                if (!primeiroItem.hasOwnProperty('nome_setor') || !primeiroItem.hasOwnProperty('numero')) {
                    window.adicionarLog('error', 'Arquivo de contatos deve conter as colunas "nome_setor" e "numero"');
                    document.getElementById('statusContatos').innerHTML = '❌ Formato Inválido';
                    document.getElementById('statusContatos').style.color = '#dc3545';
                    return;
                }

                // Formatar números de telefone
                dados.forEach(contato => {
                    contato.numero = window.formatarTelefone(contato.numero);
                });

                window.dadosContatos = dados;
                document.getElementById('statusContatos').innerHTML = '✅ Carregado';
                document.getElementById('statusContatos').style.color = '#28a745';
                document.getElementById('uploadCard3').classList.add('loaded');
                
                window.adicionarLog('success', `Arquivo de contatos carregado: ${window.dadosContatos.length} registros`);
                window.processarDados();
            });
        };

        window.processarDados = function() {
            if (!window.dadosSetor || !window.dadosCategoria || !window.dadosContatos) {
                return; // Aguarda todos os arquivos
            }

            try {
                window.dadosProcessados = [];
                let setoresEncontrados = 0;
                let setoresNaoEncontrados = [];
                
                // Processa cada contato/setor
                window.dadosContatos.forEach(contato => {
                    // Normaliza o nome do setor para busca
                    const nomeSetorNormalizado = contato.nome_setor?.trim().toLowerCase();
                    
                    // Busca dados do setor no arquivo principal (busca flexível)
                    const setorData = window.dadosSetor.find(s => 
                        s.Setor?.trim().toLowerCase() === nomeSetorNormalizado ||
                        s.Setor?.trim().toLowerCase().includes(nomeSetorNormalizado) ||
                        nomeSetorNormalizado?.includes(s.Setor?.trim().toLowerCase())
                    );
                    
                    if (!setorData) {
                        setoresNaoEncontrados.push(contato.nome_setor);
                        return;
                    }

                    setoresEncontrados++;

                    // Busca classificações estouradas para este setor
                    const classificacoesEstouradas = window.dadosCategoria.filter(c => {
                        const setorCategoria = c.Setor?.trim().toLowerCase();
                        return setorCategoria === nomeSetorNormalizado && 
                               (c.REALIZADO || 0) > (c.ORÇADO || 0);
                    });

                    // Validação de dados numéricos
                    const orcado = parseFloat(setorData.ORÇADO) || 0;
                    const realizado = parseFloat(setorData.REALIZADO) || 0;

                    window.dadosProcessados.push({
                        nome: contato.nome_setor,
                        telefone: contato.numero,
                        orcado: orcado,
                        realizado: realizado,
                        classificacoes: classificacoesEstouradas.map(c => ({
                            nome: c.Classificação || 'Não informado',
                            orcado: parseFloat(c.ORÇADO) || 0,
                            realizado: parseFloat(c.REALIZADO) || 0
                        }))
                    });
                });

                // Log de resultados do processamento
                if (setoresNaoEncontrados.length > 0) {
                    window.adicionarLog('warning', `⚠️ ${setoresNaoEncontrados.length} setores não encontrados no orçamento: ${setoresNaoEncontrados.join(', ')}`);
                }
                
                window.adicionarLog('success', `✅ ${setoresEncontrados} setores processados com sucesso`);

                window.atualizarEstatisticas();
                window.renderizarSetores();
                
                // Habilita o botão de disparar
                document.getElementById('disparadorBtn').disabled = false;
                
                window.adicionarLog('success', `Dados processados com sucesso! ${window.dadosProcessados.length} setores prontos para disparo.`);
                
            } catch (error) {
                window.adicionarLog('error', `Erro ao processar dados: ${error.message}`);
                console.error('Erro detalhado:', error);
            }
        };

        window.calcularPercentual = function(realizado, orcado) {
            return orcado > 0 ? (realizado / orcado) * 100 : 0;
        };

        window.getStatusClass = function(percentual) {
            if (percentual >= 100) return 'danger';
            if (percentual >= 90) return 'warning';
            return 'success';
        };

        window.getStatusText = function(percentual) {
            if (percentual >= 100) return '🚨 Ultrapassou';
            if (percentual >= 90) return '⚠️ Próximo';
            return '✅ Controlado';
        };

        window.atualizarEstatisticas = function() {
            let ultrapassados = 0;
            let proximos = 0;
            let controlados = 0;

            window.dadosProcessados.forEach(setor => {
                const percentual = window.calcularPercentual(setor.realizado, setor.orcado);
                if (percentual >= 100) ultrapassados++;
                else if (percentual >= 90) proximos++;
                else controlados++;
            });

            document.getElementById('setoresUltrapassados').textContent = ultrapassados;
            document.getElementById('setoresProximos').textContent = proximos;
            document.getElementById('setoresControlados').textContent = controlados;
            document.getElementById('totalSetores').textContent = window.dadosProcessados.length;
        };

        window.renderizarSetores = function() {
            const container = document.getElementById('setoresList');
            container.innerHTML = '';

            if (window.dadosProcessados.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>⚠️ Atenção:</strong> Nenhum setor encontrado. Verifique se os arquivos foram carregados corretamente e se os nomes dos setores coincidem entre os arquivos.
                    </div>
                `;
                return;
            }

            // Ordena setores por percentual (maiores primeiro)
            const setoresOrdenados = [...window.dadosProcessados].sort((a, b) => {
                const percA = window.calcularPercentual(a.realizado, a.orcado);
                const percB = window.calcularPercentual(b.realizado, b.orcado);
                return percB - percA;
            });

            setoresOrdenados.forEach(setor => {
                const percentual = window.calcularPercentual(setor.realizado, setor.orcado);
                const statusClass = window.getStatusClass(percentual);
                const statusText = window.getStatusText(percentual);

                const setorElement = document.createElement('div');
                setorElement.className = `setor-item ${statusClass}`;
                
                setorElement.innerHTML = `
                    <div class="setor-header">
                        <div class="setor-name">${setor.nome}</div>
                        <div class="setor-status status-${statusClass}">${statusText}</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-${statusClass}" style="width: ${Math.min(percentual, 100)}%"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #666; margin-bottom: 5px;">
                        <span>Orçado: R$ ${setor.orcado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        <span>Realizado: R$ ${setor.realizado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        <span>${percentual.toFixed(1)}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #888;">
                        <span>📞 ${setor.telefone}</span>
                        <span>${setor.classificacoes.length} classificação(ões) estourada(s)</span>
                    </div>
                `;

                container.appendChild(setorElement);
            });
        };

        window.gerarMensagem = function(setor) {
            const percentual = window.calcularPercentual(setor.realizado, setor.orcado);
            let status;
            
            if (percentual >= 100) {
                status = "🚨 *ATENÇÃO: Setor ultrapassou o orçamento!*";
            } else if (percentual >= 90) {
                status = "⚠️ *ALERTA: Setor próximo de atingir o orçamento!*";
            } else {
                status = "✅ Situação controlada.";
            }

            let mensagem = `📊 *RELATÓRIO ORÇAMENTÁRIO*\n`;
            mensagem += `🏢 *Setor:* ${setor.nome}\n`;
            mensagem += `💰 *Orçado:* R$ ${setor.orcado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
            mensagem += `💸 *Realizado:* R$ ${setor.realizado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
            mensagem += `📈 *Percentual Atingido:* ${percentual.toFixed(2)}%\n\n`;
            mensagem += `${status}\n`;

            if (setor.classificacoes && setor.classificacoes.length > 0) {
                mensagem += "\n🔍 *CLASSIFICAÇÕES QUE ULTRAPASSARAM O ORÇAMENTO:*\n";
                setor.classificacoes.forEach((c, index) => {
                    const percClassif = window.calcularPercentual(c.realizado, c.orcado);
                    mensagem += `\n${index + 1}. *${c.nome}*\n`;
                    mensagem += `   • Orçado: R$ ${c.orcado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                    mensagem += `   • Realizado: R$ ${c.realizado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                    mensagem += `   • Ultrapassou: ${percClassif.toFixed(1)}%\n`;
                });
            }

            mensagem += `\n📅 *Relatório gerado em:* ${new Date().toLocaleString('pt-BR')}\n`;
            mensagem += `🤖 *Sistema de Controle Orçamentário*`;

            return mensagem;
        };

        window.enviarMensagemWhatsApp = async function(mensagem, telefone) {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiInstance = document.getElementById('apiInstance').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!apiUrl || !apiInstance || !apiKey) {
                throw new Error('Configuração da API incompleta');
            }

            const url = `${apiUrl}/message/sendText/${apiInstance}`;
            const payload = {
                number: telefone,
                textMessage: {
                    text: mensagem
                }
            };
window.enviarMensagemWhatsAppComRetry = async function(mensagem, telefone, tentativas = 3) {
    const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
    let ultimaResposta = null;

    for (let tentativa = 1; tentativa <= tentativas; tentativa++) {
        try {
            const resposta = await window.enviarMensagemWhatsApp(mensagem, telefone);
            if (resposta.success) return resposta;

            ultimaResposta = resposta;
            window.adicionarLog('warning', `⚠️ ${telefone} - Tentativa ${tentativa} falhou: ${resposta.response?.message || resposta.rawResponse}`);
        } catch (error) {
            ultimaResposta = { error: error.message };
            window.adicionarLog('warning', `⚠️ ${telefone} - Erro na tentativa ${tentativa}: ${error.message}`);
        }

        if (tentativa < tentativas) {
            window.adicionarLog('info', `⏳ ${telefone} - Aguardando ${tentativa * 3}s para próxima tentativa...`);
            await delay(tentativa * 3000);
        }
    }

    return ultimaResposta;
};

            
            const headers = {
                "Content-Type": "application/json",
                "apikey": apiKey
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload),
                    timeout: 30000 // 30 segundos de timeout
                });

                const responseText = await response.text();
                let responseJson;
                
                try {
                    responseJson = JSON.parse(responseText);
                } catch (e) {
                    responseJson = { message: responseText };
                }

                return {
                    status: response.status,
                    success: response.ok,
                    response: responseJson,
                    rawResponse: responseText
                };
            } catch (error) {
                throw new Error(`Erro de rede: ${error.message}`);
            }
        };
        window.enviarMensagemWhatsAppComRetry = async function(mensagem, telefone, tentativas = 3) {
    const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
    let ultimaResposta = null;

    for (let tentativa = 1; tentativa <= tentativas; tentativa++) {
        try {
            const resposta = await window.enviarMensagemWhatsApp(mensagem, telefone);
            if (resposta.success) return resposta;

            ultimaResposta = resposta;
            window.adicionarLog('warning', `⚠️ ${telefone} - Tentativa ${tentativa} falhou: ${resposta.response?.message || resposta.rawResponse}`);
        } catch (error) {
            ultimaResposta = { error: error.message };
            window.adicionarLog('warning', `⚠️ ${telefone} - Erro na tentativa ${tentativa}: ${error.message}`);
        }

        if (tentativa < tentativas) {
            window.adicionarLog('info', `⏳ ${telefone} - Aguardando ${tentativa * 3}s para próxima tentativa...`);
            await delay(tentativa * 3000);
        }
    }

    return ultimaResposta;
};

        window.numeroValido = function(numero) {
    return /^55\d{10,11}$/.test(numero);
};

        window.dispararMensagens = async function() {
            if (window.dadosProcessados.length === 0) {
                window.adicionarLog('error', '❌ Nenhum setor carregado para disparo!');
                return;
            }

            const apiStatus = document.getElementById('apiStatus');
            if (apiStatus.textContent === 'OFFLINE') {
                window.adicionarLog('warning', '⚠️ Teste a conexão com a API antes de disparar mensagens');
                return;
            }

            const btn = document.getElementById('disparadorBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px;"></div> Enviando mensagens...';

            window.adicionarLog('info', `🚀 Iniciando disparo para ${window.dadosProcessados.length} setores...`);

            let sucessos = 0;
            let erros = 0;
            const logDetalhado = [];

            for (const [index, setor] of window.dadosProcessados.entries()) {
                try {
                    window.adicionarLog('info', `📤 Enviando para ${setor.nome} (${index + 1}/${window.dadosProcessados.length})...`);
                    
                    const mensagem = window.gerarMensagem(setor);
                    const resultado = await window.enviarMensagemWhatsAppComRetry(mensagem, setor.telefone);

                    if (resultado.success) {
                        window.adicionarLog('success', `✅ ${setor.nome} - Mensagem enviada com sucesso`);
                        sucessos++;
                        logDetalhado.push(`✅ ${setor.nome}: Sucesso`);
                    } else {
                        const errorMsg = resultado.response?.message || resultado.rawResponse || 'Erro desconhecido';
                        window.adicionarLog('error', `❌ ${setor.nome} - Erro: ${errorMsg}`);
                        erros++;
                        logDetalhado.push(`❌ ${setor.nome}: ${errorMsg}`);
                    }

                    // Aguarda 2 segundos entre envios para não sobrecarregar a API
                    if (index < window.dadosProcessados.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                    
                } catch (error) {
                    window.adicionarLog('error', `❌ ${setor.nome} - Erro: ${error.message}`);
                    erros++;
                    logDetalhado.push(`❌ ${setor.nome}: ${error.message}`);
                    
                    // Em caso de erro de rede, aguarda mais tempo
                    if (error.message.includes('rede') || error.message.includes('timeout')) {
                        await new Promise(resolve => setTimeout(resolve, 5000));
                    }
                }
            }

            // Log final detalhado
            window.adicionarLog('info', `🏁 Disparo finalizado! ${sucessos} sucessos, ${erros} erros.`);
            
            if (sucessos > 0) {
                window.adicionarLog('success', `✅ Mensagens enviadas com sucesso: ${sucessos}`);
            }
            
            if (erros > 0) {
                window.adicionarLog('error', `❌ Falhas no envio: ${erros}`);
            }

            btn.disabled = false;
            btn.innerHTML = '<span>📤</span> Disparar Mensagens para Setores';
        };

        window.recarregarDados = function() {
            // Reset dos dados
            window.dadosSetor = null;
            window.dadosCategoria = null;
            window.dadosContatos = null;
            window.dadosProcessados = [];

            // Reset da interface
            document.getElementById('statusSetor').innerHTML = 'Aguardando arquivo...';
            document.getElementById('statusSetor').style.color = '#666';
            document.getElementById('uploadCard1').classList.remove('loaded');

            document.getElementById('statusCategoria').innerHTML = 'Aguardando arquivo...';
            document.getElementById('statusCategoria').style.color = '#666';
            document.getElementById('uploadCard2').classList.remove('loaded');

            document.getElementById('statusContatos').innerHTML = 'Aguardando arquivo...';
            document.getElementById('statusContatos').style.color = '#666';
            document.getElementById('uploadCard3').classList.remove('loaded');

            // Reset das estatísticas
            document.getElementById('setoresUltrapassados').textContent = '-';
            document.getElementById('setoresProximos').textContent = '-';
            document.getElementById('setoresControlados').textContent = '-';
            document.getElementById('totalSetores').textContent = '-';

            // Reset da lista de setores
            document.getElementById('setoresList').innerHTML = `
                <div class="alert alert-warning">
                    <strong>⚠️ Atenção:</strong> Carregue os arquivos Excel acima para visualizar os dados dos setores.
                </div>
            `;

            // Desabilita o botão
            document.getElementById('disparadorBtn').disabled = true;

            // Limpa os inputs de arquivo
            document.getElementById('fileSetor').value = '';
            document.getElementById('fileCategoria').value = '';
            document.getElementById('fileContatos').value = '';

            window.adicionarLog('info', '🔄 Dados recarregados. Carregue os arquivos novamente.');
        };

        // Função para validar entrada de dados
        window.validarDados = function() {
            const problemas = [];
            
            if (!window.dadosSetor || window.dadosSetor.length === 0) {
                problemas.push('Arquivo de orçamento geral não carregado');
            }
            
            if (!window.dadosCategoria || window.dadosCategoria.length === 0) {
                problemas.push('Arquivo de orçamento por categoria não carregado');
            }
            
            if (!window.dadosContatos || window.dadosContatos.length === 0) {
                problemas.push('Arquivo de contatos não carregado');
            }
            
            if (problemas.length > 0) {
                window.adicionarLog('warning', `⚠️ Problemas encontrados: ${problemas.join(', ')}`);
                return false;
            }
            
            return true;
        };

        // Inicialização quando a página carrega
        document.addEventListener('DOMContentLoaded', function() {
            window.adicionarLog('success', '🎉 Sistema inicializado com sucesso!');
            window.adicionarLog('info', '📋 Configure a API WhatsApp e carregue os 3 arquivos para começar.');
            
            // Testa automaticamente a API na inicialização
            setTimeout(() => {
                window.testarAPI();
            }, 1000);
        });

        // Adiciona listener para mudanças nos campos da API
        ['apiUrl', 'apiInstance', 'apiKey'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('change', function() {
                const statusElement = document.getElementById('apiStatus');
                statusElement.textContent = 'OFFLINE';
                statusElement.className = 'api-status offline';
            });
        });
    </script>
</body>
</html>